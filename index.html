<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Crowded Runways</title>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<style type="text/css">
			@import url('https://fonts.googleapis.com/css?family=Overpass');

			body {
				font-family: 'Overpass', sans-serif;
			}

			h1, h3, h4 {
				padding: 0px;
    		margin: 0px;
			}

			.formbox {
				position: absolute;
				padding: 10px 0px 10px 10px;
				background-color: #008165;
				color: white;
				border-radius: 15px;
				border-style: solid;
				border-color: white;
				-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			}

      #tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 10px;
        background-color: #008165;
				color: white;
        -webkit-border-radius: 0px;
        -moz-border-radius: 0px;
        border-radius: 15px;
				border-style: solid;
    		border-color: white;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
      }

      .hidden {
        display: none;
      }

      #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
      }
		</style>
	</head>
	<body>
	<div id="container" style="width:100%;">
		<div class="formbox" id="left" style="float:left; width:12%;">
			<h3>Crowded Runways</h3>
			<br>
			<form>
				<label>Year</label>
				<select id="year">
					<option id="year-2017">2017</option>
					<option id="year-2016">2016</option>
					<option id="year-2015">2015</option>
					<option id="year-2014">2014</option>
					<option id="year-2013">2013</option>
					<option id="year-2012">2012</option>
					<option id="year-2011">2011</option>
				</select>
			</form>
			<br>
			<form>
				<label>Month</label>
				<select id="month">
					<option id="month-01">January</option>
					<option id="month-02">February</option>
					<option id="month-03">March</option>
					<option id="month-04">April</option>
					<option id="month-05">May</option>
					<option id="month-06">June</option>
					<option id="month-07" selected="selected">July</option>
					<option id="month-08">August</option>
					<option id="month-09">September</option>
					<option id="month-10">October</option>
					<option id="month-11">November</option>
					<option id="month-12">December</option>
				</select>
			</form>
			<br>
			<form>
				<div>
					<label>Color Scale</label><br>
					<input type="radio" id="avg-taxi-out-range" name="color-scale" checked> Avg Taxi Out<br>
					<input type="radio" id="avg-taxi-in-range" name="color-scale"> Avg Taxi In<br>
					<input type="radio" id="long-taxi-out-range" name="color-scale"> Longest Taxi Out</br>
					<input type="radio" id="long-taxi-in-range" name="color-scale"> Longest Taxi In</br>
				</div>
			</form>
		</div>
		<div id="right" style="float:right; width:88%;">
			<div class="hidden" id="tooltip">
				<h1 id="airport-code"></h1>
				<h3 id="location"></h3>
				<h4 id="city-state"></h3><br>
				<span id="text-1"></span><br>
				<span id="text-2"></span><br>
				<span id="text-3"></span><br>
				<span id="text-4"></span><br>
				<small id="text-5"></span>
				</div>
				<script type="text/javascript">

				//Width and height
				var w = 1000;
				var h = 600;

				//Define map projection
				var projection = d3.geoAlbersUsa()
				.translate([w/2, h/2])
				.scale([1000]);

				//Define path generator
				var path = d3.geoPath()
				.projection(projection);

				//Define quantize scale to sort data values into buckets of color
				var color = d3.scaleQuantize()
				.range(['#63C246', '#8DFA56', '#D0FC5A', '#FFFE56', '#F3B641', '#E58849', '#E73225']);

				//Create SVG element
				var svg = d3.select("div#right")
				.append("svg")
				.attr("width", w)
				.attr("height", h);

				if (document.getElementById("year-2017").selected === true) {
					d3.select("option#month-08").classed("hidden", true);
					d3.select("option#month-09").classed("hidden", true);
					d3.select("option#month-10").classed("hidden", true);
					d3.select("option#month-11").classed("hidden", true);
					d3.select("option#month-12").classed("hidden", true);
				}

				var yearNumber = document.getElementById('year').value
				var monthNumber = document.getElementById('month').selectedIndex + 1
						monthNumber = ("0" + monthNumber).slice(-2);

				var fileDate = `${yearNumber}_${monthNumber}`

				//Load in raw taxi data
				d3.csv(`monthly_data/${fileDate}.csv`, (data) => {
					var avgTaxiOutRange = data.map((d) => {return parseFloat(d.avg_taxi_out)})

				//Set domain
					color.domain([
						d3.min(avgTaxiOutRange, function(d) { return d; }),
						d3.max(avgTaxiOutRange, function(d) { return d; })
					]);

					//Load in GeoJSON data
					d3.json("us-states.json", function(json) {

						//Bind data and create one path per GeoJSON feature
						svg.selectAll("path")
						.data(json.features)
						.enter()
						.append("path")
						.attr("d", path)
						.style("fill", "#3768B7");

						data.sort((a, b) => {return a.total_takeoffs - b.total_takeoffs})
						svg.selectAll("circle")
						.data(data)
						.enter()
						.append("circle")
						.attr("cx", function(d) {
							return projection([d.longitude, d.latitude])[0];
						})
						.attr("cy", function(d) {
							return projection([d.longitude, d.latitude])[1];
						})
						.attr("r", 5)
						.style("fill", (d) => {
							var value = d.avg_taxi_out;
							return color(value)
						})
						.style("stroke", "gray")
						.style("stroke-width", 0.25)
						.style("opacity", 0.85)
						.on("mouseover", (d) => {
							function hourPlur(float) {
								if (parseInt(float) > 1) {
									return `${parseInt(float)} hours`
								} else {
									return `${parseInt(float)} hour`
								}
							}

							function minPlur(float) {
								if (parseInt(float) > 1) {
									return `${parseInt(float)} minutes`
								} else {
									return `${parseInt(float)} minute`
								}
							}

							function secPlur(float) {
								if (parseInt(float) > 1) {
									return `${parseInt(float)} seconds`
								} else {
									return `${parseInt(float)} second`
								}
							}

							function secondizer(float) {
								if (parseInt(float) > 60 && parseInt(float) % 60 !== 0 && parseInt((float - parseInt(float)) * 60) === 0) {
									return `${hourPlur(parseInt(float/60))}, ${minPlur(parseInt(float) % 60)}`
								} else if (parseInt(float) < 60 && parseInt((float - parseInt(float)) * 60) > 0) {
									return `${minPlur(parseInt(float))}, ${secPlur(parseInt((float - parseInt(float)) * 60))}`
								} else if (parseInt(float) > 60 && parseInt((float - parseInt(float)) * 60) > 0) {
									return `${hourPlur(parseInt(float/60))}, ${minPlur(parseInt(float) % 60)}, ${secPlur(parseInt((float - parseInt(float)) * 60))}`
								} else if (parseInt(float) < 60 && parseInt((float - parseInt(float)) * 60) === 0) {
									return `${minPlur(parseInt(float))}`
								} else if (parseInt(float) % 60 === 0 && parseInt((float - parseInt(float)) * 60) === 0) {
									return `${hourPlur((float/60))}`
								} else if (parseInt(float) % 60 === 0 && parseInt((float - parseInt(float)) * 60) > 0) {
									return `${hourPlur(parseInt(float/60))}, ${secPlur(parseInt((float - parseInt(float)) * 60))}`
								}
							}

							var airportCode = `${d.iata_faa}`
							var airport = `${d.name}`
							var cityState = `${d.city_state}`
							var avgTaxiOut = `Average Taxi Out: ${secondizer(d.avg_taxi_out)}`
							var avgTaxiIn = `Average Taxi In: ${secondizer(d.avg_taxi_in)}`
							var longestTaxiOut = `Longest Taxi Out: ${secondizer(d.longest_taxi_out)} (${d.lng_tx_out_date})`
							var longestTaxiIn = `Longest Taxi In: ${secondizer(d.longest_taxi_in)} (${d.lng_tx_in_date})`
							var takeoffsLandings = `Total Takeoffs: ${d.total_takeoffs}, Total Landings: ${d.total_landings}`

							var coordinates = [d3.event.clientX, d3.event.clientY]
							var divOffset = 220
							var windowHeight = document.getElementById('right').clientHeight

							if (coordinates[1] + divOffset > windowHeight) {
								d3.select("#tooltip")
								.style("left", coordinates[0] + "px")
								.style("top", (coordinates[1] - divOffset) + "px")
								.select("h1#airport-code")
								.text(airportCode)
							} else {
								d3.select("#tooltip")
								.style("left", coordinates[0] + "px")
								.style("top", coordinates[1] + "px")
								.select("h1#airport-code")
								.text(airportCode)
							}

							d3.select("#tooltip")
							.select("h3#location")
							.text(airport)

							d3.select("#tooltip")
							.select("h4#city-state")
							.text(cityState)

							d3.select("#tooltip")
							.select("span#text-1")
							.text(avgTaxiOut)

							d3.select("#tooltip")
							.select("span#text-2")
							.text(avgTaxiIn)

							d3.select("#tooltip")
							.select("span#text-3")
							.text(longestTaxiOut)

							d3.select("#tooltip")
							.select("span#text-4")
							.text(longestTaxiIn)

							d3.select("#tooltip")
							.select("small#text-5")
							.text(takeoffsLandings)

							//Show the tooltip
							d3.select("#tooltip").classed("hidden", false);
						})
						.on("mouseout", (d) => {
							d3.select("#tooltip").classed("hidden", true);
						})
					})
					d3.selectAll("input").on("change", () => {
						var avgTaxiOutRange = data.map((d) => {return parseFloat(d.avg_taxi_out)})
						var avgTaxiInRange = data.map((d) => {return parseFloat(d.avg_taxi_in)})
						var longTaxiOutRange = data.map((d) => {return parseFloat(d.longest_taxi_out)})
						var longTaxiInRange = data.map((d) => {return parseFloat(d.longest_taxi_in)})

						//Set domain
						if (document.getElementById("avg-taxi-out-range").checked === true) {
							color.domain([
								d3.min(avgTaxiOutRange, function(d) { return d; }),
								d3.max(avgTaxiOutRange, function(d) { return d; })
							])
							svg.selectAll("circle")
							.style("fill", (d) => {
								var value = d.avg_taxi_out;
								return color(value)
							});
						} else if (document.getElementById("avg-taxi-in-range").checked === true) {
							color.domain([
								d3.min(avgTaxiInRange, function(d) { return d; }),
								d3.max(avgTaxiInRange, function(d) { return d; })
							])
							svg.selectAll("circle")
							.style("fill", (d) => {
								var value = d.avg_taxi_in;
								return color(value)
							});
						} else if (document.getElementById("long-taxi-out-range").checked === true) {
							color.domain([
								d3.min(longTaxiOutRange, function(d) { return d; }),
								d3.max(longTaxiOutRange, function(d) { return d; })
							])
							svg.selectAll("circle")
							.style("fill", (d) => {
								var value = d.longest_taxi_out;
								return color(value)
							});
						} else if (document.getElementById("long-taxi-in-range").checked === true) {
							color.domain([
								d3.min(longTaxiInRange, function(d) { return d; }),
								d3.max(longTaxiInRange, function(d) { return d; })
							])
							svg.selectAll("circle")
							.style("fill", (d) => {
								var value = d.longest_taxi_in;
								return color(value)
							});
						}
						console.log(color.domain())
					})
					d3.selectAll("select#year").on("change", () => {
						if (document.getElementById("year-2017").selected === true) {
							d3.select("option#month-08").classed("hidden", true);
							d3.select("option#month-09").classed("hidden", true);
							d3.select("option#month-10").classed("hidden", true);
							d3.select("option#month-11").classed("hidden", true);
							d3.select("option#month-12").classed("hidden", true);
						} else if (document.getElementById("year-2017").selected === false) {
							d3.select("option#month-08").classed("hidden", false);
							d3.select("option#month-09").classed("hidden", false);
							d3.select("option#month-10").classed("hidden", false);
							d3.select("option#month-11").classed("hidden", false);
							d3.select("option#month-12").classed("hidden", false);
						}
					})
				});
			</script>
		</div>
	</div>
	</body>
</html>
